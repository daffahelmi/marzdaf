#!/bin/bash

# Nama file script dan lokasi
SCRIPT_PATH="/usr/local/bin/fixmarzban.sh"
SERVICE_PATH="/etc/systemd/system/fixmarzban.service"

# 1. Menyimpan script bash
echo "Menyimpan script bash..."
cat > $SCRIPT_PATH << 'EOF'
container_name="marzban-marzban-1"  # Nama container Marzban

# Mengecek apakah perintah docker ada di path
if ! command -v docker &> /dev/null
then
    echo "Docker tidak ditemukan, pastikan Docker terinstal."
    exit 1
fi

while true; do
    if docker logs "$container_name" --tail 5 2>&1 | grep -q "maximum number of running instances reached"; then
        echo "Pesan terdeteksi, melakukan restart Marzban..."
        docker restart "$container_name"
        sleep 60  # Tunggu sebentar sebelum melanjutkan pemantauan
    fi
    sleep 60  # Interval waktu pengecekan
done
EOF

# Memberikan izin eksekusi pada script
chmod +x $SCRIPT_PATH

# 2. Menyimpan unit file systemd
echo "Menyimpan unit file systemd..."
cat > $SERVICE_PATH << 'EOF'
[Unit]
Description=Marzban Log Monitoring Script
After=network.target

[Service]
ExecStart=/usr/local/bin/fixmarzban.sh
Restart=always
User=root
Group=root

[Install]
WantedBy=multi-user.target
EOF

# 3. Memuat ulang systemd, mengaktifkan dan memulai service
echo "Memuat ulang systemd dan mengaktifkan service..."
systemctl daemon-reload
systemctl enable fixmarzban.service
systemctl start fixmarzban.service
